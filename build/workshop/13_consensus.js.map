{"version":3,"file":"13_consensus.js","sourceRoot":"","sources":["../../src/workshop/13_consensus.ts"],"names":[],"mappings":"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","sourcesContent":["import { sha256 } from \"js-sha256\";\r\nimport { serialize, deserialize } from \"serializer.ts/Serializer\";\r\nimport BigNumber from \"bignumber.js\";\r\n\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport deepEqual = require(\"deep-equal\");\r\n\r\nimport * as uuidv4 from \"uuid/v4\";\r\nimport * as express from \"express\";\r\nimport * as bodyParser from \"body-parser\";\r\nimport { URL } from \"url\";\r\nimport axios from \"axios\";\r\n\r\nimport { Set } from \"typescript-collections\";\r\nimport * as parseArgs from \"minimist\";\r\n\r\nexport type Address = string;\r\n\r\nexport class Transaction {\r\n  public senderAddress: Address;\r\n  public recipientAddress: Address;\r\n  public value: number;\r\n\r\n  constructor(senderAddress: Address, recipientAddress: Address, value: number) {\r\n    this.senderAddress = senderAddress;\r\n    this.recipientAddress = recipientAddress;\r\n    this.value = value;\r\n  }\r\n}\r\n\r\nexport class Block {\r\n  public blockNumber: number;\r\n  public transactions: Array<Transaction>;\r\n  public timestamp: number;\r\n  public nonce: number;\r\n  public prevBlock: string;\r\n\r\n  constructor(blockNumber: number, transactions: Array<Transaction>, timestamp: number, nonce: number,\r\n    prevBlock: string) {\r\n    this.blockNumber = blockNumber;\r\n    this.transactions = transactions;\r\n    this.timestamp = timestamp;\r\n    this.nonce = nonce;\r\n    this.prevBlock = prevBlock;\r\n  }\r\n\r\n  // Calculates the SHA256 of the entire block, including its transactions.\r\n  public sha256(): string {\r\n    return sha256(JSON.stringify(serialize<Block>(this)));\r\n  }\r\n}\r\n\r\nexport class Node {\r\n  public id: string;\r\n  public url: URL;\r\n\r\n  constructor(id: string, url: URL) {\r\n    this.id = id;\r\n    this.url = url;\r\n  }\r\n\r\n  public toString(): string {\r\n      return `${this.id}:${this.url}`;\r\n  }\r\n}\r\n\r\nexport class Blockchain {\r\n  // Let's define that our \"genesis\" block as an empty block, starting from the January 1, 1970 (midnight \"UTC\").\r\n  public static readonly GENESIS_BLOCK = new Block(0, [], 0, 0, \"fiat lux\");\r\n\r\n  public static readonly DIFFICULTY = 4;\r\n  public static readonly TARGET = 2 ** (256 - Blockchain.DIFFICULTY);\r\n\r\n  public static readonly MINING_SENDER = \"<COINBASE>\";\r\n  public static readonly MINING_REWARD = 50;\r\n\r\n  public nodeId: string;\r\n  public nodes: Set<Node>;\r\n  public blocks: Array<Block>;\r\n  public transactionPool: Array<Transaction>;\r\n  private storagePath: string;\r\n\r\n  constructor(nodeId: string) {\r\n    this.nodeId = nodeId;\r\n    this.nodes = new Set<Node>();\r\n    this.transactionPool = [];\r\n\r\n    this.storagePath = path.resolve(__dirname, \"../\", `${this.nodeId}.blockchain`);\r\n\r\n    // Load the blockchain from the storage.\r\n    this.load();\r\n  }\r\n\r\n  // Registers new node.\r\n  public register(node: Node): boolean {\r\n    return this.nodes.add(node);\r\n  }\r\n\r\n  // Saves the blockchain to the disk.\r\n  private save() {\r\n    fs.writeFileSync(this.storagePath, JSON.stringify(serialize(this.blocks), undefined, 2), \"utf8\");\r\n  }\r\n\r\n  // Loads the blockchain from the disk.\r\n  private load() {\r\n    try {\r\n      this.blocks = deserialize<Block[]>(Block, JSON.parse(fs.readFileSync(this.storagePath, \"utf8\")));\r\n    } catch (err) {\r\n      if (err.code !== \"ENOENT\") {\r\n        throw err;\r\n      }\r\n\r\n      this.blocks = [Blockchain.GENESIS_BLOCK];\r\n    } finally {\r\n      this.verify();\r\n    }\r\n  }\r\n\r\n  // Verifies the blockchain.\r\n  public static verify(blocks: Array<Block>): boolean {\r\n    try {\r\n      // The blockchain can't be empty. It should always contain at least the genesis block.\r\n      if (blocks.length === 0) {\r\n        throw new Error(\"Blockchain can't be empty!\");\r\n      }\r\n\r\n      // The first block has to be the genesis block.\r\n      if (!deepEqual(blocks[0], Blockchain.GENESIS_BLOCK)) {\r\n        throw new Error(\"Invalid first block!\");\r\n      }\r\n\r\n      // Verify the chain itself.\r\n      for (let i = 1; i < blocks.length; ++i) {\r\n        const current = blocks[i];\r\n\r\n        // Verify block number.\r\n        if (current.blockNumber !== i) {\r\n          throw new Error(`Invalid block number ${current.blockNumber} for block #${i}!`);\r\n        }\r\n\r\n        // Verify that the current blocks properly points to the previous block.\r\n        const previous = blocks[i - 1];\r\n        if (current.prevBlock !== previous.sha256()) {\r\n          throw new Error(`Invalid previous block hash for block #${i}!`);\r\n        }\r\n\r\n        // Verify the difficutly of the PoW.\r\n        //\r\n        // TODO: what if the diffuclty was adjusted?\r\n        if (!this.isPoWValid(current.sha256())) {\r\n          throw new Error(`Invalid previous block hash's difficutly for block #${i}!`);\r\n        }\r\n      }\r\n\r\n      return true;\r\n    } catch (err) {\r\n      console.error(err);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Verifies the blockchain.\r\n  private verify() {\r\n    // The blockchain can't be empty. It should always contain at least the genesis block.\r\n    if (!Blockchain.verify(this.blocks)) {\r\n      throw new Error(\"Invalid blockchain!\");\r\n    }\r\n  }\r\n\r\n  // Receives candidate blockchains, verifies them, and if a longer and valid alternative is found - uses it to replace\r\n  // our own.\r\n  public consensus(blockchains: Array<Array<Block>>): boolean {\r\n    // Iterate over the proposed candidates and find the longest, valid, candidate.\r\n    let maxLength: number = 0;\r\n    let bestCandidateIndex: number = -1;\r\n\r\n    for (let i = 0; i < blockchains.length; ++i) {\r\n      const candidate = blockchains[i];\r\n\r\n      // Don't bother validating blockchains shorther than the best candidate so far.\r\n      if (candidate.length <= maxLength) {\r\n        continue;\r\n      }\r\n\r\n      // Found a good candidate?\r\n      if (Blockchain.verify(candidate)) {\r\n        maxLength = candidate.length;\r\n        bestCandidateIndex = i;\r\n      }\r\n    }\r\n\r\n    // Compare the candidate and consider to use it.\r\n    if (bestCandidateIndex !== -1 && (maxLength > this.blocks.length || !Blockchain.verify(this.blocks))) {\r\n      this.blocks = blockchains[bestCandidateIndex];\r\n      this.save();\r\n\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  // Validates PoW.\r\n  public static isPoWValid(pow: string): boolean {\r\n    try {\r\n      if (!pow.startsWith(\"0x\")) {\r\n        pow = `0x${pow}`;\r\n      }\r\n\r\n      return new BigNumber(pow).lessThanOrEqualTo(Blockchain.TARGET.toString());\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Mines for block.\r\n  private mineBlock(transactions: Array<Transaction>): Block {\r\n    // Create a new block which will \"point\" to the last block.\r\n    const lastBlock = this.getLastBlock();\r\n    const newBlock = new Block(lastBlock.blockNumber + 1, transactions, Blockchain.now(), 0, lastBlock.sha256());\r\n\r\n    while (true) {\r\n      const pow = newBlock.sha256();\r\n      console.log(`Mining #${newBlock.blockNumber}: nonce: ${newBlock.nonce}, pow: ${pow}`);\r\n\r\n      if (Blockchain.isPoWValid(pow)) {\r\n        console.log(`Found valid POW: ${pow}!`);\r\n        break;\r\n      }\r\n\r\n      newBlock.nonce++;\r\n    }\r\n\r\n    return newBlock;\r\n  }\r\n\r\n  // Submits new transaction\r\n  public submitTransaction(senderAddress: Address, recipientAddress: Address, value: number) {\r\n    this.transactionPool.push(new Transaction(senderAddress, recipientAddress, value));\r\n  }\r\n\r\n  // Creates new block on the blockchain.\r\n  public createBlock(): Block {\r\n    // Add a \"coinbase\" transaction granting us the mining reward!\r\n    const transactions = [new Transaction(Blockchain.MINING_SENDER, this.nodeId, Blockchain.MINING_REWARD),\r\n      ...this.transactionPool];\r\n\r\n    // Mine the transactions in a new block.\r\n    const newBlock = this.mineBlock(transactions);\r\n\r\n    // Append the new block to the blockchain.\r\n    this.blocks.push(newBlock);\r\n\r\n    // Remove the mined transactions.\r\n    this.transactionPool = [];\r\n\r\n    // Save the blockchain to the storage.\r\n    this.save();\r\n\r\n    return newBlock;\r\n  }\r\n\r\n  public getLastBlock(): Block {\r\n    return this.blocks[this.blocks.length - 1];\r\n  }\r\n\r\n  public static now(): number {\r\n    return Math.round(new Date().getTime() / 1000);\r\n  }\r\n}\r\n\r\n// Web server:\r\nconst ARGS = parseArgs(process.argv.slice(2));\r\nconst PORT = ARGS.port || 3000;\r\nconst app = express();\r\nconst nodeId = ARGS.id || uuidv4();\r\nconst blockchain = new Blockchain(nodeId);\r\n\r\n// Set up bodyParser:\r\napp.use(bodyParser.urlencoded({ extended: false }));\r\napp.use(bodyParser.json());\r\napp.use((err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {\r\n  console.error(err.stack);\r\n\r\n  res.status(500);\r\n});\r\n\r\n// Show all the blocks.\r\napp.get(\"/blocks\", (req: express.Request, res: express.Response) => {\r\n  res.json(serialize(blockchain.blocks));\r\n});\r\n\r\n// Show specific block.\r\napp.get(\"/blocks/:id\", (req: express.Request, res: express.Response) => {\r\n  const id = Number(req.params.id);\r\n  if (isNaN(id)) {\r\n    res.json(\"Invalid parameter!\");\r\n    res.status(500);\r\n    return;\r\n  }\r\n\r\n  if (id >= blockchain.blocks.length) {\r\n    res.json(`Block #${id} wasn't found!`);\r\n    res.status(404);\r\n    return;\r\n  }\r\n\r\n  res.json(serialize(blockchain.blocks[id]));\r\n});\r\n\r\napp.post(\"/blocks/mine\", (req: express.Request, res: express.Response) => {\r\n  // Mine the new block.\r\n  const newBlock = blockchain.createBlock();\r\n\r\n  res.json(`Mined new block #${newBlock.blockNumber}`);\r\n});\r\n\r\n// Show all transactions in the transaction pool.\r\napp.get(\"/transactions\", (req: express.Request, res: express.Response) => {\r\n  res.json(serialize(blockchain.transactionPool));\r\n});\r\n\r\napp.post(\"/transactions\", (req: express.Request, res: express.Response) => {\r\n  const senderAddress = req.body.senderAddress;\r\n  const recipientAddress = req.body.recipientAddress;\r\n  const value = Number(req.body.value);\r\n\r\n  if (!senderAddress || !recipientAddress || !value)  {\r\n    res.json(\"Invalid parameters!\");\r\n    res.status(500);\r\n    return;\r\n  }\r\n\r\n  blockchain.submitTransaction(senderAddress, recipientAddress, value);\r\n\r\n  res.json(`Transaction from ${senderAddress} to ${recipientAddress} was added successfully`);\r\n});\r\n\r\napp.get(\"/nodes\", (req: express.Request, res: express.Response) => {\r\n  res.json(serialize(blockchain.nodes.toArray()));\r\n});\r\n\r\napp.post(\"/nodes\", (req: express.Request, res: express.Response) => {\r\n  const id = req.body.id;\r\n  const url = new URL(req.body.url);\r\n\r\n  if (!id || !url)  {\r\n    res.json(\"Invalid parameters!\");\r\n    res.status(500);\r\n    return;\r\n  }\r\n\r\n  const node = new Node(id, url);\r\n\r\n  if (blockchain.register(node)) {\r\n    res.json(`Registered node: ${node}`);\r\n  } else {\r\n    res.json(`Node ${node} already exists!`);\r\n    res.status(500);\r\n  }\r\n});\r\n\r\napp.put(\"/nodes/consensus\", (req: express.Request, res: express.Response) => {\r\n  // Fetch the state of the other nodes.\r\n  const requests = blockchain.nodes.toArray().map(node => axios.get(`${node.url}blocks`));\r\n\r\n  if (requests.length === 0) {\r\n    res.json(\"There are nodes to sync with!\");\r\n    res.status(404);\r\n\r\n    return;\r\n  }\r\n\r\n  axios.all(requests).then(axios.spread((...blockchains) => {\r\n    if (blockchain.consensus(blockchains.map(res => deserialize<Block[]>(Block, res.data)))) {\r\n      res.json(`Node ${nodeId} has reached a consensus on a new state.`);\r\n    } else {\r\n      res.json(`Node ${nodeId} hasn't reached a consensus on the existing state.`);\r\n    }\r\n\r\n    res.status(200);\r\n    return;\r\n  })).catch(err => {\r\n    console.log(err);\r\n    res.status(500);\r\n    res.json(err);\r\n    return;\r\n  });\r\n\r\n  res.status(500);\r\n});\r\n\r\nif (!module.parent) {\r\n  app.listen(PORT);\r\n\r\n  console.log(`Web server started on port ${PORT}. Node ID is: ${nodeId}`);\r\n}\r\n"]}