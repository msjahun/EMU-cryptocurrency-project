{"version":3,"file":"06_pow.js","sourceRoot":"","sources":["../../src/workshop/06_pow.ts"],"names":[],"mappings":"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","sourcesContent":["import { sha256 } from \"js-sha256\";\r\nimport { serialize } from \"serializer.ts/Serializer\";\r\nimport BigNumber from \"bignumber.js\";\r\n\r\nexport type Address = string;\r\n\r\nexport class Transaction {\r\n  public senderAddress: Address;\r\n  public recipientAddress: Address;\r\n  public value: number;\r\n\r\n  constructor(senderAddress: Address, recipientAddress: Address, value: number) {\r\n    this.senderAddress = senderAddress;\r\n    this.recipientAddress = recipientAddress;\r\n    this.value = value;\r\n  }\r\n}\r\n\r\nexport class Block {\r\n  public blockNumber: number;\r\n  public transactions: Array<Transaction>;\r\n  public timestamp: number;\r\n  public nonce: number;\r\n  public prevBlock: string;\r\n\r\n  constructor(blockNumber: number, transactions: Array<Transaction>, timestamp: number, nonce: number,\r\n    prevBlock: string) {\r\n    this.blockNumber = blockNumber;\r\n    this.transactions = transactions;\r\n    this.timestamp = timestamp;\r\n    this.nonce = nonce;\r\n    this.prevBlock = prevBlock;\r\n  }\r\n\r\n  // Calculates the SHA256 of the entire block, including its transactions.\r\n  public sha256(): string {\r\n    return sha256(JSON.stringify(serialize<Block>(this)));\r\n  }\r\n}\r\n\r\nexport class Blockchain {\r\n  // Let's define that our \"genesis\" block as an empty block, starting from now.\r\n  public static readonly GENESIS_BLOCK = new Block(0, [], Blockchain.now(), 0, \"\");\r\n\r\n  public static readonly DIFFICULTY = 4;\r\n  public static readonly TARGET = 2 ** (256 - Blockchain.DIFFICULTY);\r\n\r\n  public nodeId: string;\r\n  public blocks: Array<Block>;\r\n  public transactionPool: Array<Transaction>;\r\n\r\n  constructor(nodeId: string) {\r\n    this.nodeId = nodeId;\r\n    this.blocks = [Blockchain.GENESIS_BLOCK];\r\n    this.transactionPool = [];\r\n  }\r\n\r\n  // Validates PoW.\r\n  public static isPoWValid(pow: string): boolean {\r\n    try {\r\n      if (!pow.startsWith(\"0x\")) {\r\n        pow = `0x${pow}`;\r\n      }\r\n\r\n      return new BigNumber(pow).lessThanOrEqualTo(Blockchain.TARGET.toString());\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Mines for block.\r\n  public mineBlock(transactions: Array<Transaction>): Block {\r\n    // Create a new block which will \"point\" to the last block.\r\n    const lastBlock = this.getLastBlock();\r\n    const newBlock = new Block(lastBlock.blockNumber + 1, transactions, Blockchain.now(), 0, lastBlock.sha256());\r\n\r\n    while (true) {\r\n      const pow = newBlock.sha256();\r\n      console.log(`Mining #${newBlock.blockNumber}: nonce: ${newBlock.nonce}, pow: ${pow}`);\r\n\r\n      if (Blockchain.isPoWValid(pow)) {\r\n        console.log(`Found valid POW: ${pow}!`);\r\n        break;\r\n      }\r\n\r\n      newBlock.nonce++;\r\n    }\r\n\r\n    return newBlock;\r\n  }\r\n\r\n  // Submits new transaction\r\n  public submitTransaction(senderAddress: Address, recipientAddress: Address, value: number) {\r\n    this.transactionPool.push(new Transaction(senderAddress, recipientAddress, value));\r\n  }\r\n\r\n  // Creates new block on the blockchain.\r\n  public createBlock() {\r\n    // TBD\r\n  }\r\n\r\n  public getLastBlock(): Block {\r\n    return this.blocks[this.blocks.length - 1];\r\n  }\r\n\r\n  public static now(): number {\r\n    return Math.round(new Date().getTime() / 1000);\r\n  }\r\n}\r\n\r\nconst blockchain = new Blockchain(\"node123\");\r\n\r\nconst txn1 = new Transaction(\"Alice\", \"Bob\", 1000);\r\nconst txn2 = new Transaction(\"Alice\", \"Eve\", 12345);\r\nconst block = blockchain.mineBlock([txn1, txn2]);\r\nconsole.log(`Mined block: ${JSON.stringify(serialize(block))}`);\r\nconsole.log(`Mined block with: ${block.sha256()}`);\r\n"]}